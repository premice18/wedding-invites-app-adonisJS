@layout.app({ title: 'Code Secours' })

@slot('main')
<div class="max-w-md mx-auto">
    <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Validation par Code Secours</h2>
        <p class="text-gray-600">Utilisez le code à 6 chiffres en cas de problème avec le QR Code</p>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6">
        <form id="backupForm" class="space-y-4">
            {{ csrfField() }}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Code de secours (6 chiffres)</label>
                <input type="text" id="backupCode" name="backupCode" pattern="[0-9]{6}" maxlength="6" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-center text-xl font-mono focus:outline-none focus:ring-2 focus:ring-pink-500"
                    placeholder="123456">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ID du Mariage</label>
                <input type="number" id="weddingId" name="weddingId" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
                    placeholder="1">
            </div>

            <button type="submit"
                class="w-full bg-pink-600 text-white px-6 py-3 rounded-md hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-pink-500">
                Valider l'invitation
            </button>
        </form>

        <!-- Résultat -->
        <div id="result" class="text-center p-4 rounded-lg hidden mt-4">
            <div id="resultIcon" class="text-4xl mb-2"></div>
            <h3 id="resultTitle" class="text-xl font-semibold mb-2"></h3>
            <p id="resultMessage" class="text-gray-600"></p>
            <div id="guestInfo" class="mt-4 p-4 bg-gray-50 rounded-lg hidden"></div>
        </div>
    </div>
</div>

<script>
    document.getElementById('backupForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const backupCode = document.getElementById('backupCode').value;
        const weddingId = document.getElementById('weddingId').value;

        if (!backupCode || !weddingId) {
            alert('Veuillez remplir tous les champs');
            return;
        }

        try {
            const response = await fetch('/api/scan/backup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    backupCode: backupCode,
                    weddingId: parseInt(weddingId)
                })
            });

            const result = await response.json();
            showResult(result);

            // Réinitialiser le formulaire en cas de succès
            if (result.success) {
                document.getElementById('backupForm').reset();
            }

        } catch (error) {
            showResult({
                success: false,
                message: 'Erreur lors de la validation'
            });
        }
    });

    function showResult(result) {
        const resultDiv = document.getElementById('result');
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const guestInfo = document.getElementById('guestInfo');

        resultDiv.classList.remove('hidden');

        if (result.success) {
            resultDiv.className = 'text-center p-4 rounded-lg bg-green-50 border border-green-200';
            resultIcon.textContent = '✅';
            resultTitle.textContent = 'Code Validé!';
            resultTitle.className = 'text-xl font-semibold mb-2 text-green-800';
            resultMessage.textContent = result.message;
            resultMessage.className = 'text-green-600';

            // Afficher les infos de l'invité
            if (result.guest) {
                guestInfo.innerHTML = `
                <h4 class="font-semibold text-gray-800">${result.guest.first_name} ${result.guest.last_name}</h4>
                <p class="text-gray-600">${result.guest.confirmed_people} personne(s) présente(s)</p>
                <p class="text-gray-600">Table: ${result.guest.table_number || 'Non assignée'}</p>
                ${result.guest.dietary_restrictions ? `<p class="text-gray-600">Régime: ${result.guest.dietary_restrictions}</p>` : ''}
            `;
                guestInfo.classList.remove('hidden');
            }

        } else {
            resultDiv.className = 'text-center p-4 rounded-lg bg-red-50 border border-red-200';
            resultIcon.textContent = '❌';
            resultTitle.textContent = 'Erreur';
            resultTitle.className = 'text-xl font-semibold mb-2 text-red-800';
            resultMessage.textContent = result.message;
            resultMessage.className = 'text-red-600';
            guestInfo.classList.add('hidden');
        }
    }
</script>
@endslot
@end